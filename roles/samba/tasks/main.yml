---
# ----- Share directories -----

- name: Create /srv/media
  file:
    path: /srv/media
    state: directory
    owner: root
    group: media
    mode: "2775"

- name: Create /srv/timemachine
  file:
    path: /srv/timemachine
    state: directory
    owner: root
    group: timemachine
    mode: "2770"

- name: Create /srv/backups
  file:
    path: /srv/backups
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Create /srv/compose
  file:
    path: /srv/compose
    state: directory
    owner: root
    group: root
    mode: "0755"

# ----- Config -----

- name: Deploy smb.conf
  copy:
    src: smb.conf
    dest: /etc/samba/smb.conf
    owner: root
    group: root
    mode: "0644"
    validate: /usr/bin/testparm -s %s
  notify: restart samba

# ----- Samba users -----
# Check existing users first (pdbedit may fail on an uninitialized database;
# failed_when: false treats that as "no users" and proceeds to add them).
# Passwords passed via environment variable to avoid shell quoting issues
# (echo -e is not portable â€” dash ignores -e, mangling the password input).

- name: Get current samba user list
  command: pdbedit -L
  register: samba_users
  changed_when: false
  failed_when: false

- name: Add cokert as samba user
  shell: printf '%s\n%s\n' "$SAMBA_PASS" "$SAMBA_PASS" | smbpasswd -s -a cokert
  environment:
    SAMBA_PASS: "{{ vault_samba_password_cokert }}"
  when: samba_users.stdout is not search('^cokert:', multiline=True)
  no_log: true

- name: Add tm as samba user
  shell: printf '%s\n%s\n' "$SAMBA_PASS" "$SAMBA_PASS" | smbpasswd -s -a tm
  environment:
    SAMBA_PASS: "{{ vault_samba_password_tm }}"
  when: samba_users.stdout is not search('^tm:', multiline=True)
  no_log: true

# ----- Services -----

- name: Enable and start smbd
  service:
    name: smbd
    enabled: true
    state: started

- name: Enable and start nmbd
  service:
    name: nmbd
    enabled: true
    state: started
