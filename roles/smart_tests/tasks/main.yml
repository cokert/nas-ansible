---
- name: Deploy smart-selftest@.service template unit
  copy:
    src: smart-selftest@.service
    dest: /etc/systemd/system/smart-selftest@.service
    owner: root
    group: root
    mode: "0644"
  notify: reload systemd

- name: Deploy short-test service units
  template:
    src: smart-selftest-short.service.j2
    dest: /etc/systemd/system/smart-selftest@short-{{ item.tag }}.service
    owner: root
    group: root
    mode: "0644"
  loop: "{{ smart_drives }}"
  notify: reload systemd

- name: Deploy long-test service units
  template:
    src: smart-selftest-long.service.j2
    dest: /etc/systemd/system/smart-selftest@long-{{ item.long_day | lower }}-{{ item.tag }}.service
    owner: root
    group: root
    mode: "0644"
  loop: "{{ smart_drives }}"
  notify: reload systemd

- name: Deploy short-test timer units
  template:
    src: smart-selftest-short.timer.j2
    dest: /etc/systemd/system/smart-selftest-short-{{ item.tag }}.timer
    owner: root
    group: root
    mode: "0644"
  loop: "{{ smart_drives }}"
  notify: reload systemd

- name: Deploy long-test timer units
  template:
    src: smart-selftest-long.timer.j2
    dest: /etc/systemd/system/smart-selftest-long-{{ item.long_day | lower }}-{{ item.tag }}.timer
    owner: root
    group: root
    mode: "0644"
  loop: "{{ smart_drives }}"
  notify: reload systemd

- name: Flush handlers to run daemon-reload before enabling timers
  meta: flush_handlers

- name: Enable and start short-test timers
  service:
    name: "smart-selftest-short-{{ item.tag }}.timer"
    enabled: true
    state: started
  loop: "{{ smart_drives }}"

- name: Enable and start long-test timers
  service:
    name: "smart-selftest-long-{{ item.long_day | lower }}-{{ item.tag }}.timer"
    enabled: true
    state: started
  loop: "{{ smart_drives }}"
