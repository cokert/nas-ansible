---
# ----- Pool: import or create -----

- name: Check if ZFS pool '{{ zfs_pool_name }}' is already imported
  command: zpool list {{ zfs_pool_name }}
  register: pool_check
  failed_when: false
  changed_when: false

- name: Attempt to import existing ZFS pool '{{ zfs_pool_name }}'
  command: zpool import -f {{ zfs_pool_name }}
  when: pool_check.rc != 0
  register: pool_import
  failed_when: false

- name: Fail if pool not found and zfs_create_pool is not set
  fail:
    msg: |
      ZFS pool '{{ zfs_pool_name }}' was not found and could not be imported.
      If the drives are new and you want to CREATE a fresh pool (WARNING: destructive!),
      re-run with:
        ansible-playbook site.yml -e zfs_create_pool=true
  when:
    - pool_check.rc != 0
    - pool_import is defined
    - pool_import.rc != 0
    - not (zfs_create_pool | bool)

- name: Create ZFS pool '{{ zfs_pool_name }}' (DESTRUCTIVE — only with zfs_create_pool=true)
  command: >
    zpool create {{ zfs_pool_name }}
    mirror
      /dev/disk/by-id/{{ zfs_pool_drives.mirror0[0] }}
      /dev/disk/by-id/{{ zfs_pool_drives.mirror0[1] }}
    mirror
      /dev/disk/by-id/{{ zfs_pool_drives.mirror1[0] }}
      /dev/disk/by-id/{{ zfs_pool_drives.mirror1[1] }}
    -o ashift=12
  when:
    - pool_check.rc != 0
    - pool_import is defined
    - pool_import.rc != 0
    - zfs_create_pool | bool

# ----- Pool properties -----

- name: Set pool-level properties on tank
  command: zfs set {{ item.property }}={{ item.value }} {{ zfs_pool_name }}
  loop: "{{ zfs_pool_properties }}"
  changed_when: false

# ----- Datasets -----
# community.general.zfs is idempotent: reads current state and only calls
# zfs set when a value differs. This matters for mountpoint changes, which
# cause ZFS to unmount/remount — unnecessary changes risk "dataset is busy"
# if samba or other services have the path open.

- name: Ensure ZFS datasets exist with properties
  community.general.zfs:
    name: "{{ item.name }}"
    state: present
    extra_zfs_properties: "{{ item | dict2items | rejectattr('key', 'equalto', 'name') | items2dict }}"
  loop: "{{ zfs_datasets }}"

# ----- Export on shutdown (Ubuntu packaging gap) -----
# Ubuntu's zfsutils-linux 2.2.2 does not ship a zfs-unmount or export service.
# Without this, pools are left unclean on shutdown, causing zfs-import-cache
# to fail on next boot ("previously in use from another system").

- name: Deploy zfs-export-on-shutdown.service
  copy:
    src: zfs-export-on-shutdown.service
    dest: /etc/systemd/system/zfs-export-on-shutdown.service
    owner: root
    group: root
    mode: "0644"
  notify: reload systemd and enable export service

- name: Set pool cachefile to /etc/zfs/zpool.cache
  command: zpool set cachefile=/etc/zfs/zpool.cache {{ zfs_pool_name }}
  changed_when: false
